<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Private Â· Zen Lab</title>
  <link rel="icon" href="assets/Logo.svg">
  <link rel="stylesheet" href="assets/style.css">
  <script defer src="assets/script.js"></script>
  <!-- <script defer src="assets/toDo.js"></script> --> <!-- ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ë¹„í™œì„±í™” -->

  <!-- Dropbox JS SDK -->
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>

  <style>
    .js-toDoList { list-style-type: none; padding-left: 0; }
    .js-toDoList button { font-size: 12px; padding: 2px 5px; background: transparent; border:none; cursor:pointer; }
    .rich-text-editor { width:100%; min-height:200px; border:1px solid #ccc; padding:10px; background:#f9f9f9; margin-top:20px; }
    .calendar-container { font-family:Arial,sans-serif; padding:20px; border-radius:8px; max-width:400px; margin:20px 0; background:#f0f0f0; }
    .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .calendar-header button { background:none; border:none; font-size:1.5em; cursor:pointer; }
    .calendar-days { display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-weight:bold; }
    .calendar-dates { display:grid; grid-template-columns:repeat(7,1fr); text-align:center; }
    .calendar-dates div { padding:10px; cursor:pointer; }
    .calendar-dates .selected-date { background:#007bff; color:#fff; border-radius:50%; }
    
    /* ì¸ì¦ ìƒíƒœ í‘œì‹œ */
    .auth-status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
    .auth-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .auth-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .auth-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    
    .btn { padding: 8px 16px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
  </style>
</head>

<body>
    <nav class="nav">
        <a class="logo" href="index.html">Zen Lab</a>
        <input id="menu-toggle" type="checkbox">
        <label class="menu-button-container" for="menu-toggle">
            <span class="menu-button"></span>
        </label>
        <ul class="menu">
            <li><a href="news.html">ğŸ‰News</a></li>
            <li><a href="research.html">Research</a></li>
            <li><a href="members.html">Members</a></li>
            <li><a href="publications.html">Publications</a></li>
            <li><a href="teaching.html">Teaching</a></li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
    </nav>

    <main class="private-wrap">
    <section id="app">
        
        <!-- ì¸ì¦ ìƒíƒœ í‘œì‹œ -->
        <div id="auth-status" class="auth-status auth-pending">
            Dropbox ì—°ê²° í™•ì¸ ì¤‘...
        </div>
        
        <div id="auth-actions" style="margin-bottom: 20px;">
            <button id="connect-btn" class="btn btn-primary" style="display:none;">Dropbox ì—°ê²°</button>
            <button id="disconnect-btn" class="btn btn-secondary" style="display:none;">ì—°ê²° í•´ì œ</button>
        </div>

        <!-- Todo -->
        <div class ="Todo">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
               <h3 id="todo-list">Todo List - YYYY.MM.DD</h3> 
               <div>
                   <button class="btn btn-secondary" id="loadBtntd" style="display:none;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                   <button class="btn btn-success" id="saveBtntd" style="display:none;">ì €ì¥</button>
               </div>
            </div>
            <form class="js-toDoForm">
                <input type="text" placeholder="Write a to do" />
                <button type="button" class="js-addBtn">Add</button>
            </form>
            <ul class="js-toDoList">
            </ul>
        </div>

        <!-- Report -->
        <div class="report-editor">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 id="report-title">Daily Report - YYYY.MM.DD</h3>
                <div>
                    <button class="btn btn-secondary" id="loadBtn" style="display:none;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button class="btn btn-success" id="saveBtn" style="display:none;">ì €ì¥</button>
                </div>
            </div>
            <div class="rich-text-editor" id="report-content" contenteditable="true">
              <p>Write your daily report here...</p>
            </div>
        </div>
        
        <!-- Calendar -->
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prev-month">â€¹</button>
                <h3 id="month-year"></h3>
                <button id="next-month">â€º</button>
                <button id="today-btn">Today</button>
            </div>
            <div class="calendar-days">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div class="calendar-dates" id="calendar-dates"></div>
        </div>
    </section>
    </main>
    
    <footer class="footer">
        <div>&copy; <span id="year"></span> Zen Lab. All rights reserved.</div>
    </footer>

    <script>
      // ======= PKCE í—¬í¼ í•¨ìˆ˜ë“¤ =======
      function base64URLEncode(str) {
          return btoa(String.fromCharCode.apply(null, str))
              .replace(/\+/g, '-')
              .replace(/\//g, '_')
              .replace(/=/g, '');
      }

      function generateRandomString(length) {
          const array = new Uint8Array(length);
          crypto.getRandomValues(array);
          return base64URLEncode(array);
      }

      async function sha256(plain) {
          const encoder = new TextEncoder();
          const data = encoder.encode(plain);
          return window.crypto.subtle.digest('SHA-256', data);
      }

      async function generatePKCEPair() {
          const codeVerifier = generateRandomString(32);
          const hashed = await sha256(codeVerifier);
          const codeChallenge = base64URLEncode(new Uint8Array(hashed));
          return { codeVerifier, codeChallenge };
      }
      
      // DOM ìš”ì†Œë“¤
      const calendarDatesEl = document.getElementById('calendar-dates');
      const monthYearEl = document.getElementById('month-year');
      const prevBtn = document.getElementById('prev-month');
      const nextBtn = document.getElementById('next-month');
      const todayBtn = document.getElementById('today-btn');
      
      const todolistEl = document.getElementById('todo-list');
      const reportTitleEl = document.getElementById('report-title');
      const reportContentEl = document.getElementById('report-content');

      const saveBtntdEl = document.getElementById('saveBtntd');
      const saveBtnEl = document.getElementById('saveBtn');
      const loadBtntdEl = document.getElementById('loadBtntd');
      const loadBtnEl = document.getElementById('loadBtn');
      
      const authStatusEl = document.getElementById('auth-status');
      const connectBtnEl = document.getElementById('connect-btn');
      const disconnectBtnEl = document.getElementById('disconnect-btn');

      const APP_KEY = 'nubtwdkq9uvn2ka';
      const REDIRECT_URI = window.location.origin + '/private.html'; // auth.html ëŒ€ì‹  ì§ì ‘ ì²˜ë¦¬

      // ë‚ ì§œ ê´€ë ¨
      const today = new Date();
      let currentDate = new Date();
      let selectedDate = new Date();
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      
      // Dropbox ì¸ìŠ¤í„´ìŠ¤
      let dbx = null;
      
      // ======= ì¸ì¦ ê´€ë¦¬ =======
      function updateAuthStatus(status, message) {
          authStatusEl.className = `auth-status auth-${status}`;
          authStatusEl.textContent = message;
          
          const isConnected = status === 'success';
          connectBtnEl.style.display = isConnected ? 'none' : 'inline-block';
          disconnectBtnEl.style.display = isConnected ? 'inline-block' : 'none';
          
          // ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í‘œì‹œ
          const buttonsToToggle = [saveBtnEl, saveBtntdEl, loadBtnEl, loadBtntdEl];
          buttonsToToggle.forEach(btn => {
              if (btn) btn.style.display = isConnected ? 'inline-block' : 'none';
          });
      }
      
      function saveTokens(accessToken, refreshToken = null, codeVerifier = null) {
          const tokenData = {
              accessToken,
              refreshToken,
              codeVerifier,
              timestamp: Date.now()
          };
          localStorage.setItem('dropbox_tokens', JSON.stringify(tokenData));
      }
      
      function loadTokens() {
          try {
              const saved = localStorage.getItem('dropbox_tokens');
              if (!saved) return null;
              
              const tokenData = JSON.parse(saved);
              // í† í°ì´ 24ì‹œê°„ ì´ìƒ ì˜¤ë˜ë˜ì—ˆìœ¼ë©´ ë¬´íš¨í™”
              if (Date.now() - tokenData.timestamp > 24 * 60 * 60 * 1000) {
                  localStorage.removeItem('dropbox_tokens');
                  return null;
              }
              return tokenData;
          } catch (e) {
              console.error('í† í° ë¡œë“œ ì‹¤íŒ¨:', e);
              return null;
          }
      }
      
      function clearTokens() {
          localStorage.removeItem('dropbox_tokens');
      }
      
      async function initializeDropbox() {
          try {
              // URLì—ì„œ ì¸ì¦ ì½”ë“œ í™•ì¸ (ì´ì œ ì§ì ‘ ì²˜ë¦¬)
              const urlParams = new URLSearchParams(window.location.search);
              const code = urlParams.get('code');
              
              if (code) {
                  // ì¸ì¦ ì½”ë“œê°€ ìˆìœ¼ë©´ í† í° êµí™˜ ì‹œë„
                  await handleAuthCode(code);
                  // URLì—ì„œ ì½”ë“œ ì œê±°
                  window.history.replaceState({}, document.title, window.location.pathname);
                  return;
              }
              
              // ì €ì¥ëœ í† í° í™•ì¸
              const tokens = loadTokens();
              if (tokens && tokens.accessToken) {
                  dbx = new Dropbox.Dropbox({ accessToken: tokens.accessToken });
                  
                  // í† í° ìœ íš¨ì„± ê²€ì‚¬
                  try {
                      await dbx.usersGetCurrentAccount();
                      updateAuthStatus('success', 'Dropbox ì—°ê²°ë¨');
                      return;
                  } catch (e) {
                      console.log('ì €ì¥ëœ í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ:', e);
                      clearTokens();
                  }
              }
              
              // ì—°ê²°ë˜ì§€ ì•Šì€ ìƒíƒœ
              updateAuthStatus('error', 'Dropbox ì—°ê²° í•„ìš”');
              
          } catch (e) {
              console.error('Dropbox ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
              updateAuthStatus('error', 'Dropbox ì—°ê²° ì‹¤íŒ¨: ' + e.message);
          }
      }
      
      async function handleAuthCode(code) {
          try {
              updateAuthStatus('pending', 'ì¸ì¦ ì²˜ë¦¬ ì¤‘...');
              
              // ì €ì¥ëœ code_verifier ê°€ì ¸ì˜¤ê¸°
              const tokens = loadTokens();
              const codeVerifier = tokens?.codeVerifier;
              
              if (!codeVerifier) {
                  throw new Error('PKCE code_verifierë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦í•´ì£¼ì„¸ìš”.');
              }
              
              // PKCEë¥¼ ì‚¬ìš©í•œ í† í° êµí™˜
              const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: new URLSearchParams({
                      grant_type: 'authorization_code',
                      code: code,
                      client_id: APP_KEY,
                      redirect_uri: REDIRECT_URI,
                      code_verifier: codeVerifier // PKCE í•„ìˆ˜
                  })
              });
              
              if (!response.ok) {
                  const errorText = await response.text();
                  throw new Error(`HTTP ${response.status}: ${errorText}`);
              }
              
              const tokenData = await response.json();
              
              if (tokenData.access_token) {
                  saveTokens(tokenData.access_token, tokenData.refresh_token);
                  dbx = new Dropbox.Dropbox({ accessToken: tokenData.access_token });
                  
                  // ì—°ê²° í…ŒìŠ¤íŠ¸
                  await dbx.usersGetCurrentAccount();
                  updateAuthStatus('success', 'Dropbox ì—°ê²° ì„±ê³µ!');
              } else {
                  throw new Error('ì•¡ì„¸ìŠ¤ í† í°ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
              }
              
          } catch (e) {
              console.error('ì¸ì¦ ì²˜ë¦¬ ì‹¤íŒ¨:', e);
              updateAuthStatus('error', 'ì¸ì¦ ì‹¤íŒ¨: ' + e.message);
              clearTokens();
          }
      }
      
      async function connectToDropbox() {
          try {
              // PKCE ì½”ë“œ ìƒì„±
              const { codeVerifier, codeChallenge } = await generatePKCEPair();
              
              // code_verifierë¥¼ ì„ì‹œ ì €ì¥ (ì¸ì¦ ì™„ë£Œ í›„ ì‚¬ìš©)
              saveTokens(null, null, codeVerifier);
              
              // ì¸ì¦ URL ìƒì„± (PKCE ì‚¬ìš©)
              const authUrl = `https://www.dropbox.com/oauth2/authorize?` + new URLSearchParams({
                  client_id: APP_KEY,
                  response_type: 'code',
                  redirect_uri: REDIRECT_URI,
                  code_challenge: codeChallenge,
                  code_challenge_method: 'S256',
                  token_access_type: 'offline' // refresh tokenì„ ìœ„í•´
              });
              
              window.location.href = authUrl;
          } catch (e) {
              console.error('ì¸ì¦ URL ìƒì„± ì‹¤íŒ¨:', e);
              updateAuthStatus('error', 'ì¸ì¦ ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
          }
      }
      
      function disconnectFromDropbox() {
          clearTokens();
          dbx = null;
          updateAuthStatus('error', 'Dropbox ì—°ê²° í•´ì œë¨');
      }

      async function getDropboxText(response) {
        // DropboxResponse.resultì— Blobì´ ë‹´ê¸°ëŠ” ë¸Œë¼ìš°ì € ì¼€ì´ìŠ¤
        if (response?.result?.fileBlob instanceof Blob) {
            return await response.result.fileBlob.text();
        }
        // í˜¹ì‹œ SDK/ëŸ°íƒ€ì„ì— ë”°ë¼ ArrayBufferë¡œ ì˜¤ëŠ” ì¼€ì´ìŠ¤
        if (response?.result?.fileBinary) {
            // BufferSource ë˜ëŠ” ArrayBuffer ê°€ì •
            if (typeof response.result.fileBinary.text === 'function') {
                return await response.result.fileBinary.text();
            }
            if (response.result.fileBinary instanceof ArrayBuffer) {
                return new TextDecoder('utf-8').decode(response.result.fileBinary);
            }
            // Uint8Array ë“±
            if (ArrayBuffer.isView(response.result.fileBinary)) {
                return new TextDecoder('utf-8').decode(response.result.fileBinary);
            }
        }
        throw new Error('íŒŒì¼ ë³¸ë¬¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ (fileBlob/fileBinary ë¯¸ì¡´ì¬).');
      }

      
      // ======= íŒŒì¼ ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ =======
      function formatDate(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
      }
      
      async function uploadReport() {
          if (!dbx) {
              alert('ë¨¼ì € Dropboxì— ì—°ê²°í•´ì£¼ì„¸ìš”');
              return;
          }
          
          try {
              const dateKey = formatDate(selectedDate);
              const fileName = `report-${dateKey}.html`;
              const html = `<!doctype html><html><head><meta charset="utf-8"><title>Report ${dateKey}</title></head><body>${reportContentEl.innerHTML}</body></html>`;
              
              await dbx.filesUpload({
                  path: `/${fileName}`,
                  contents: html,
                  mode: { '.tag': 'overwrite' }
              });
              
              alert('Report ì €ì¥ ì™„ë£Œ!');
          } catch (e) {
              console.error('Report ì—…ë¡œë“œ ì‹¤íŒ¨:', e);
              alert('Report ì €ì¥ ì‹¤íŒ¨: ' + e.message);
          }
      }
      
      async function loadReport() {
          if (!dbx) {
              alert('ë¨¼ì € Dropboxì— ì—°ê²°í•´ì£¼ì„¸ìš”');
              return;
          }
          
          try {
              const dateKey = formatDate(selectedDate);
              const fileName = `report-${dateKey}.html`;
              
              const response = await dbx.filesDownload({ path: `/${fileName}` });
              const text = await getDropboxText(response);
              
              // HTMLì—ì„œ body ë‚´ìš©ë§Œ ì¶”ì¶œ
              const bodyMatch = text.match(/<body>(.*?)<\/body>/s);

              if (bodyMatch) {
                  reportContentEl.innerHTML = bodyMatch[1];
                  alert('Report ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
              } else {
                  reportContentEl.innerHTML = text;
                  alert('Report ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
              }
          } catch (e) {
              if (e.status === 409) {
                  alert('í•´ë‹¹ ë‚ ì§œì˜ Reportê°€ ì—†ìŠµë‹ˆë‹¤.');
              } else {
                  console.error('Report ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', e);
                  alert('Report ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message);
              }
          }
      }
      
      function collectTodos() {
          const items = Array.from(document.querySelectorAll('.js-toDoList li'));
          return items.map(li => {
              const text = li.querySelector('span').innerText;
              const isChecked = li.querySelector('input[type="checkbox"]').checked;
              return { text: text, isChecked: isChecked };
          }).filter(item => item.text.trim());
      }
      
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í˜„ì¬ Todo ëª©ë¡ ì €ì¥
      function saveTodoToLocal() {
          const dateKey = formatDate(selectedDate);
          const todoItems = collectTodos();
          localStorage.setItem(`todo_${dateKey}`, JSON.stringify(todoItems));
      }
      
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ Todo ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      function loadTodoFromLocal() {
          const dateKey = formatDate(selectedDate);
          const saved = localStorage.getItem(`todo_${dateKey}`);
          
          const todoList = document.querySelector('.js-toDoList');
          todoList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ í´ë¦¬ì–´
          
          if (saved) {
              try {
                  const todoItems = JSON.parse(saved);
                  todoItems.forEach(item => {
                      if (item.text && item.text.trim()) {
                          addTodoItem(item.text, item.isChecked || false);
                      }
                  });
              } catch (e) {
                  console.error('ë¡œì»¬ Todo ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
              }
          }
      }
      
      async function uploadTodo() {
          if (!dbx) {
              alert('ë¨¼ì € Dropboxì— ì—°ê²°í•´ì£¼ì„¸ìš”');
              return;
          }
          
          try {
              const dateKey = formatDate(selectedDate);
              const fileName = `todo-${dateKey}.json`;
              const payload = {
                  date: dateKey,
                  items: collectTodos(),
                  savedAt: new Date().toISOString()
              };
              
              await dbx.filesUpload({
                  path: `/${fileName}`,
                  contents: JSON.stringify(payload, null, 2),
                  mode: { '.tag': 'overwrite' }
              });
              
              alert('Todo List ì €ì¥ ì™„ë£Œ!');
          } catch (e) {
              console.error('Todo ì—…ë¡œë“œ ì‹¤íŒ¨:', e);
              alert('Todo List ì €ì¥ ì‹¤íŒ¨: ' + e.message);
          }
      }
      
      async function loadTodo() {
          if (!dbx) {
              alert('ë¨¼ì € Dropboxì— ì—°ê²°í•´ì£¼ì„¸ìš”');
              return;
          }
          
          try {
              const dateKey = formatDate(selectedDate);
              const fileName = `todo-${dateKey}.json`;
              
              const response = await dbx.filesDownload({ path: `/${fileName}` });

              // ì‘ë‹µ ê°ì²´ ì „ì²´ë¥¼ ì½˜ì†”ì— ì¶œë ¥í•˜ì—¬ ì–´ë–¤ ë°ì´í„°ê°€ ì˜¤ëŠ”ì§€ í™•ì¸
              console.log("Dropbox API ì‘ë‹µ:", response); 
              const text = await getDropboxText(response);
              const data = JSON.parse(text);
              
              // ê¸°ì¡´ todo ë¦¬ìŠ¤íŠ¸ í´ë¦¬ì–´
              const todoList = document.querySelector('.js-toDoList');
              todoList.innerHTML = '';
              
              // ì €ì¥ëœ todo ì•„ì´í…œë“¤ ì¶”ê°€
              if (data.items && Array.isArray(data.items)) {
                  data.items.forEach(item => {
                      // ìƒˆ í˜•ì‹ (ê°ì²´): { text, isChecked }
                      if (typeof item === 'object' && item.text) {
                          addTodoItem(item.text.trim(), item.isChecked || false);
                      }
                      // êµ¬ í˜•ì‹ (ë¬¸ìì—´): "text"
                      else if (typeof item === 'string' && item.trim()) {
                          addTodoItem(item.trim(), false);
                      }
                  });
              }
              
              alert('Todo List ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
          } catch (e) {
              if (e.status === 409) {
                  alert('í•´ë‹¹ ë‚ ì§œì˜ Todo Listê°€ ì—†ìŠµë‹ˆë‹¤.');
              } else {
                  console.error('Todo ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', e);
                  alert('Todo List ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message);
              }
          }
      }
      
      // Todo ì•„ì´í…œ ì¶”ê°€ í•¨ìˆ˜ (toDo.js ê¸°ëŠ¥ í†µí•©)
      function addTodoItem(text, isChecked = false) {
          const todoList = document.querySelector('.js-toDoList');
          const li = document.createElement('li');
          
          // ì²´í¬ë°•ìŠ¤ ì¶”ê°€
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = isChecked;

          const delBtn = document.createElement('button');
          delBtn.innerText = 'X';
          
          const span = document.createElement('span');
          span.innerText = text;

          // ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ì·¨ì†Œì„  ì ìš©
          if (isChecked) {
              span.style.textDecoration = 'line-through';
          }

          li.appendChild(checkbox);
          li.appendChild(span);
          li.appendChild(delBtn);
          todoList.appendChild(li);

          // ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ, í•´ë‹¹ í•­ëª©ì— ì™„ë£Œ ìŠ¤íƒ€ì¼ì„ ì¶”ê°€/ì œê±°
          checkbox.addEventListener('click', () => {
              span.style.textDecoration = checkbox.checked ? 'line-through' : 'none';
              saveTodoToLocal(); // ë¡œì»¬ ì €ì¥
          });

          // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ í•­ëª© ì‚­ì œ
          delBtn.addEventListener('click', (event) => {
              const li = event.target.parentElement;
              todoList.removeChild(li);
              saveTodoToLocal(); // ì‚­ì œ í›„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê°±ì‹ 
          });

          saveTodoToLocal(); // ì¶”ê°€ í›„ ë¡œì»¬ ì €ì¥
      }
      
      // ======= ë‹¬ë ¥ ê´€ë ¨ =======
      function renderCalendar() {
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();

          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
          
          monthYearEl.textContent = `${monthNames[month]} ${year}`;
          calendarDatesEl.innerHTML = '';
          
          for (let i = 0; i < firstDayOfMonth; i++) {
              calendarDatesEl.innerHTML += '<div></div>';
          }
          
          for (let i = 1; i <= lastDateOfMonth; i++) {
              const dayEl = document.createElement('div');
              dayEl.textContent = i;
              dayEl.dataset.date = formatDate(new Date(year, month, i));
              
              if (dayEl.dataset.date === formatDate(selectedDate)) {
                  dayEl.classList.add('selected-date');
              }

              dayEl.addEventListener('click', () => {
                  selectedDate = new Date(year, month, i);
                  updateReportDisplay();
                  renderCalendar();
              });
              
              calendarDatesEl.appendChild(dayEl);
          }
      }

      function updateReportDisplay() {
          const dateKey = formatDate(selectedDate);
          reportTitleEl.textContent = `Daily Report - ${dateKey}`;
          todolistEl.textContent = `Todo List - ${dateKey}`;
          
          const isToday = formatDate(selectedDate) === formatDate(today);

          if (isToday) {
              reportContentEl.contentEditable = "true";
          } else {
              reportContentEl.contentEditable = "false";
          }

          // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ Report ë°ì´í„° í™•ì¸
          const savedContent = localStorage.getItem(`report_${dateKey}`);
          if (savedContent) {
              reportContentEl.innerHTML = savedContent;
          } else {
              reportContentEl.innerHTML = '<p>No report for this date.</p>';
          }
          
          // Todo ëª©ë¡ë„ ë‚ ì§œë³„ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
          loadTodoFromLocal();
      }
      
      function handleTodayClick() {
          currentDate = new Date();
          selectedDate = new Date();
          updateReportDisplay();
          renderCalendar();
      }
      
      // ======= ìì • ë¦¬ì…‹ ê¸°ëŠ¥ (toDo.jsì—ì„œ ê°€ì ¸ì˜´) =======
      function checkAndResetIfNewDay() {
          const today = new Date().toDateString();
          const lastVisit = localStorage.getItem('lastVisitDate');
          
          if (lastVisit !== today) {
              // ìƒˆë¡œìš´ ë‚ ì´ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ë™í•˜ê³  ì˜¤ëŠ˜ ë°ì´í„° ë¡œë“œ
              localStorage.setItem('lastVisitDate', today);
              const todayDate = new Date();
              
              if (formatDate(selectedDate) !== formatDate(todayDate)) {
                  selectedDate = todayDate;
                  currentDate = todayDate;
                  updateReportDisplay();
                  renderCalendar();
              }
          }
      }
      
      // ìì •ë§ˆë‹¤ ì²´í¬í•˜ë„ë¡ ì„¤ì •
      function setupMidnightReset() {
          const now = new Date();
          const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
          const msUntilMidnight = tomorrow - now;

          setTimeout(() => {
              checkAndResetIfNewDay();
              setupMidnightReset(); // ë‹¤ì‹œ ì„¤ì •
          }, msUntilMidnight);
      }
      connectBtnEl.addEventListener('click', connectToDropbox);
      disconnectBtnEl.addEventListener('click', disconnectFromDropbox);
      
      saveBtnEl.addEventListener('click', uploadReport);
      saveBtntdEl.addEventListener('click', uploadTodo);
      loadBtnEl.addEventListener('click', loadReport);
      loadBtntdEl.addEventListener('click', loadTodo);
      
      prevBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });
      todayBtn.addEventListener('click', handleTodayClick);
      
      // ======= ì´ˆê¸°í™” =======
      document.addEventListener('DOMContentLoaded', async () => {
          await initializeDropbox();
          checkAndResetIfNewDay(); // ë‚ ì§œ ì²´í¬
          setupMidnightReset(); // ìì • ë¦¬ì…‹ ì„¤ì •
          handleTodayClick();
          document.getElementById('year').textContent = new Date().getFullYear();
      });
      
      // Todo í¼ ì´ë²¤íŠ¸ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
      const todoForm = document.querySelector('.js-toDoForm');
      if (todoForm) {
          const todoInput = todoForm.querySelector('input');
          const addBtnElement = todoForm.querySelector('.js-addBtn');
          
          if (addBtnElement && todoInput) {
              addBtnElement.addEventListener('click', () => {
                  const text = todoInput.value.trim();
                  if (text) {
                      addTodoItem(text);
                      todoInput.value = '';
                  }
              });
              
              todoInput.addEventListener('keypress', (e) => {
                  if (e.key === 'Enter') {
                      e.preventDefault();
                      addBtnElement.click();
                  }
              });
          }
      }
    </script>
</body>
</html>
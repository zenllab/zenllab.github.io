<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Private Â· Zen Lab</title>
  <link rel="icon" href="assets/Logo.svg">
  <link rel="stylesheet" href="assets/style.css">
  <script defer src="assets/script.js"></script>
  <script defer src="assets/toDo.js"></script>

  <!-- Dropbox JS SDK (ë¸Œë¼ìš°ì € ë²ˆë“¤) -->
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>

  <style>
       /* (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€) */
    .js-toDoList { list-style-type: none; padding-left: 0; }
    .js-toDoList button { font-size: 12px; padding: 2px 5px; background: transparent; border:none; cursor:pointer; }
    .rich-text-editor { width:100%; min-height:200px; border:1px solid #ccc; padding:10px; background:#f9f9f9; margin-top:20px; }
    .calendar-container { font-family:Arial,sans-serif; padding:20px; border-radius:8px; max-width:400px; margin:20px 0; background:#f0f0f0; }
    .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .calendar-header button { background:none; border:none; font-size:1.5em; cursor:pointer; }
    .calendar-days { display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-weight:bold; }
    .calendar-dates { display:grid; grid-template-columns:repeat(7,1fr); text-align:center; }
    .calendar-dates div { padding:10px; cursor:pointer; }
    .calendar-dates .selected-date { background:#007bff; color:#fff; border-radius:50%; }
  </style>
</head>


<body>
    <nav class="nav">
        <a class="logo" href="index.html">Zen Lab</a>
        <input id="menu-toggle" type="checkbox">
        <label class="menu-button-container" for="menu-toggle">
            <span class="menu-button"></span>
        </label>
        <ul class="menu">
            <li><a href="news.html">ğŸ‰News</a></li>
            <li><a href="research.html">Research</a></li>
            <li><a href="members.html">Members</a></li>
            <li><a href="publications.html">Publications</a></li>
            <li><a href="teaching.html">Teaching</a></li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
    </nav>

    <main class="private-wrap">
    <section id="app">

        <!-- Todo -->
        <div class ="Todo">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
               <h3 id="todo-list">Todo List - YYYY.MM.DD</h3> 
               <button class="btn" id="saveBtntd">Save Todo List</button>
            </div>
            <form class="js-toDoForm">
            <input type="text" placeholder="Write a to do" />
            <button type="button" class="js-addBtn">Add</button>
        </form>
        <ul class="js-toDoList">
        </ul>
        </div>

        <!-- Report -->
        <div class="report-editor">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 id="report-title">Daily Report - YYYY.MM.DD</h3>
                <button class="btn" id="saveBtn">Save Report</button>
            </div>
            <div class="rich-text-editor" id="report-content" contenteditable="true">
              <p>Write your daily report here...</p>
            </div>
        </div>
        
        <!-- Calendar -->
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prev-month">â€¹</button>
                <h3 id="month-year"></h3>
                <button id="next-month">â€º</button>
                <button id="today-btn">Today</button>
            </div>
            <div class="calendar-days">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div class="calendar-dates" id="calendar-dates"></div>
        </div>
    </section>
    
    <footer class="footer">
        <div>&copy; <span id="year"></span> Zen Lab. All rights reserved.</div>
    </footer>


    <script>

      // ======= í™˜ê²½ ì„¤ì • (í•„ìˆ˜) =======
      const calendarDatesEl = document.getElementById('calendar-dates');
      const monthYearEl = document.getElementById('month-year');
      const prevBtn = document.getElementById('prev-month');
      const nextBtn = document.getElementById('next-month');
      const todayBtn = document.getElementById('today-btn');
      
      const todolistEl = document.getElementById('todo-list');
      const reportTitleEl = document.getElementById('report-title');
      const reportContentEl = document.getElementById('report-content');

      const saveBtntdEl = document.getElementById('saveBtntd');
      const saveBtnEl = document.getElementById('saveBtn');

      const today = new Date();
      let currentDate = new Date();
      let selectedDate = new Date();
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      
      // ======= Dropbox Auth =======
      const APP_KEY = 'nubtwdkq9uvn2ka';                      // Dropbox App key
      const REDIRECT_URI = 'https://zenllab.github.io/auth.html'; // Dropbox App ì„¤ì •ì—ë„ ë™ì¼ ë“±ë¡
      const SCOPES = ['files.content.write', 'files.metadata.write'];              // ì—…ë¡œë“œ ê¶Œí•œ
      
      const dbxAuth = new Dropbox.DropboxAuth({ clientId: APP_KEY });
      
      
      function base64url(bytes){
        return btoa(String.fromCharCode(...bytes))
        .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      }

      function randomVerifier(len=64){
        const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
        const arr=new Uint32Array(len); crypto.getRandomValues(arr);
        return Array.from(arr, v=>chars[v%chars.length]).join('');
      }

      async function generatePKCE(){
        const codeVerifier = randomVerifier(64);
        const enc = new TextEncoder();
        const digest = await crypto.subtle.digest('SHA-256', enc.encode(codeVerifier));
        const codeChallenge = base64url(new Uint8Array(digest));
        return { codeVerifier, codeChallenge };
      }
      

      // ì„¸ì…˜ ì €ì¥/ë³µì›
      (function restoreAuth(){
        const saved = sessionStorage.getItem('dbx_auth');
        if (!saved) return;
        try {
          const { accessToken, refreshToken, expiresAt } = JSON.parse(saved);
          if (accessToken)  dbxAuth.setAccessToken(accessToken);
          if (refreshToken) dbxAuth.setRefreshToken(refreshToken);
          if (expiresAt)    dbxAuth.setAccessTokenExpiresAt(new Date(expiresAt));
        } catch {}
      })();

      function persistAuth() {
        sessionStorage.setItem('dbx_auth', JSON.stringify({
          accessToken: dbxAuth.getAccessToken(),
          refreshToken: dbxAuth.getRefreshToken(),
          expiresAt: dbxAuth.getAccessTokenExpiresAt()
        }));
      }

      async function ensureAuth() {
        // ìœ íš¨ í† í° ë³´ìœ  ì‹œ í†µê³¼
        if (dbxAuth.getAccessToken() && new Date() < dbxAuth.getAccessTokenExpiresAt()) 
        return;

        // ë¦¬í”„ë ˆì‹œ í† í° ë³´ìœ  ì‹œ ê°±ì‹ 
        if (dbxAuth.getRefreshToken()) {
          // SDK ì „ì—­ utilì´ ìˆë‹¤ë©´: await Dropbox.checkAndRefreshAccessToken(dbxAuth)
          await dbxAuth.refreshAccessToken(); // ë‹¨ë… ê°±ì‹ 
          persistAuth();
          return;
        }
        
        const { codeVerifier, codeChallenge } = await generatePKCE();
        sessionStorage.setItem('code_verifier', codeVerifier);
        // SDKì—(ì¬ì§„ì… ëŒ€ë¹„) ë¯¸ë¦¬ ê¸°ì–µì‹œì¼œë„ OK
        dbxAuth.setCodeVerifier(codeVerifier);

        // ìµœì´ˆ ì¸ì¦: PKCE ì½”ë“œ í”Œë¡œìš°(ë¦¬ë‹¤ì´ë ‰íŠ¸)
        const authUrl = await dbxAuth.getAuthenticationUrl(
          REDIRECT_URI,
          undefined,
          'code',          // ì‘ë‹µ íƒ€ì…
          'offline',       // refresh token í•„ìš” ì‹œ
          SCOPES,
          'none',
          true,            // usePKCE
          undefined, undefined,
          codeChallenge    // <-- ì¤‘ìš”: PKCE code_challenge
        );
        window.location.href = authUrl;
      }

      async function ensureFolder(dbx, folder){
          try {
            await dbx.filesGetMetadata({ path: folder });
          } catch(e){
            if (e?.error?.path?.['.tag'] === 'not_found'){
              await dbx.filesCreateFolderV2({ path: folder, autorename: false });
            } else {
              throw e;
            }
          }
      }

      // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ì˜ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
      function formatDate(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
      }
      
      function renderCalendar() {
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();

          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
          
          monthYearEl.textContent = `${monthNames[month]} ${year}`;
          calendarDatesEl.innerHTML = '';
          
          for (let i = 0; i < firstDayOfMonth; i++) {
              calendarDatesEl.innerHTML += '<div></div>';
          }
          
          for (let i = 1; i <= lastDateOfMonth; i++) {
              const dayEl = document.createElement('div');
              dayEl.textContent = i;
              dayEl.dataset.date = formatDate(new Date(year, month, i));
              
              if (dayEl.dataset.date === formatDate(selectedDate)) {
                  dayEl.classList.add('selected-date');
              }

              dayEl.addEventListener('click', () => {
                  selectedDate = new Date(year, month, i);
                  updateReportDisplay();
                  renderCalendar();
              });
              
              calendarDatesEl.appendChild(dayEl);
          }
      }

      function updateReportDisplay() {
          const dateKey = formatDate(selectedDate);
          reportTitleEl.textContent = `Daily Report - ${dateKey}`;
          todolistEl.textContent = `Todo List - ${dateKey}`;
          const savedContent = localStorage.getItem(dateKey);
          
          const isToday = formatDate(selectedDate) === formatDate(today);

          if (isToday) {
              reportContentEl.contentEditable = "true";
              saveBtnEl.style.display = 'inline-block';
          } else {
              reportContentEl.contentEditable = "false";
              saveBtnEl.style.display = 'none';
          }

         if (isToday) {
              reportContentEl.contentEditable = "true";
              saveBtntdEl.style.display = 'inline-block';
          } else {
              reportContentEl.contentEditable = "false";
              saveBtntdEl.style.display = 'none';
          }

          if (savedContent) {
              reportContentEl.innerHTML = savedContent;
          } else {
              reportContentEl.innerHTML = '<p>No report for this date.</p>';
          }
      }

      // ======= ì—…ë¡œë“œ: Report(HTML) =======
      async function uploadReport() {
        await ensureAuth();
        const dbx = new Dropbox.Dropbox({ auth: dbxAuth });
        const dateKey = formatDate(selectedDate);
        const parent  = `/private/${dateKey}`;
        const path    = `${parent}/report-${dateKey}.html`;
        // ìƒìœ„ í´ë” ë³´ì¥
        await ensureFolder(dbx, '/private');   // (ìµœì´ˆ 1íšŒ ëŒ€ë¹„)
        await ensureFolder(dbx, parent);
        const html = `<!doctype html><html><head><meta charset="utf-8"><title>Report ${dateKey}</title></head><body>${reportContentEl.innerHTML}</body></html>`;const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const res = await dbx.filesUpload({ path, contents: blob, mode: { '.tag': 'overwrite' } });
        persistAuth();
        alert(`Report ì—…ë¡œë“œ ì™„ë£Œ: ${res.result.path_display}`);
      }

      // ======= ì—…ë¡œë“œ: Todo(JSON) =======
      function collectTodos() {
        const items = Array.from(document.querySelectorAll('.js-toDoList li'));
        // ê° liì—ì„œ ë²„íŠ¼ í…ìŠ¤íŠ¸(X ë“±) ì œì™¸í•˜ê³  ë¼ì¸ë§Œ ì¶”ì¶œ
        return items.map(li => li.cloneNode(true).textContent.trim()).filter(Boolean);
      }

    async function uploadTodo() {
      await ensureAuth();
      const dbx = new Dropbox.Dropbox({ auth: dbxAuth });
      const dateKey = formatDate(selectedDate);
      const parent  = `/private/${dateKey}`;
      const path    = `${parent}/todo-${dateKey}.json`;
      
      // ìƒìœ„ í´ë” ë³´ì¥
      await ensureFolder(dbx, '/private');
      await ensureFolder(dbx, parent);
      
      const payload = { date: dateKey, items: collectTodos(), savedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json;charset=utf-8' });
      const res = await dbx.filesUpload({ path, contents: blob, mode: { '.tag': 'overwrite' } });
      persistAuth();
      alert(`Todo ì—…ë¡œë“œ ì™„ë£Œ: ${res.result.path_display}`);
    }

      // ======= ì´ë²¤íŠ¸ ë°”ì¸ë”© =======
      prevBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });
      // 'Today' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì •ì˜ëœ í•¨ìˆ˜ë¡œ ì—°ê²°
      todayBtn.addEventListener('click', handleTodayClick);


      // 'Today' ë²„íŠ¼ì˜ í´ë¦­ í•¸ë“¤ëŸ¬ë¥¼ ë³„ë„ì˜ í•¨ìˆ˜ë¡œ ì •ì˜ 
      function handleTodayClick() {
          currentDate = new Date();
          selectedDate = new Date();
          updateReportDisplay();
          renderCalendar();
      }

     
      function saveReportLocal() {
          const dateKey = formatDate(selectedDate);
          localStorage.setItem(dateKey, reportContentEl.innerHTML);
          alert('Report saved!');
      }
      // saveBtn.addEventListener('click', saveReportLocal);
      // saveBtntd.addEventListener('click', saveReportLocal);
 

      saveBtnEl.addEventListener('click', (e) => { e.preventDefault(); uploadReport().catch(err => { console.error(err); alert('Report ì—…ë¡œë“œ ì‹¤íŒ¨'); }); });
      saveBtntdEl.addEventListener('click', (e) => { e.preventDefault(); uploadTodo().catch(err => { console.error(err); alert('Todo ì—…ë¡œë“œ ì‹¤íŒ¨'); }); });


      // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ìë™ìœ¼ë¡œ Today í´ë¦­
      // ì´ˆê¸° ë Œë”
      document.addEventListener('DOMContentLoaded', handleTodayClick);
      document.getElementById('year').textContent = new Date().getFullYear();
    </script>
</body>
</html>

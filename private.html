<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Private ¬∑ Zen Lab</title>
  <link rel="icon" href="assets/Logo.svg">
  <link rel="stylesheet" href="assets/style.css">
  <script defer src="assets/script.js"></script>
  <!-- <script defer src="assets/toDo.js"></script> --> <!-- Ï§ëÎ≥µ Î∞©ÏßÄÎ•º ÏúÑÌï¥ ÎπÑÌôúÏÑ±Ìôî -->

  <!-- Dropbox JS SDK -->
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>

  <style>
    .js-toDoList { list-style-type: none; padding-left: 0; }
    .js-toDoList button { font-size: 12px; padding: 2px 5px; background: transparent; border:none; cursor:pointer; }
    .rich-text-editor { width:100%; min-height:200px; border:1px solid #ccc; padding:10px; background:#f9f9f9; margin-top:20px; }
    .calendar-container { font-family:Arial,sans-serif; padding:20px; border-radius:8px; max-width:400px; margin:20px 0; background:#f0f0f0; }
    .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .calendar-header button { background:none; border:none; font-size:1.5em; cursor:pointer; }
    .calendar-days { display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-weight:bold; }
    .calendar-dates { display:grid; grid-template-columns:repeat(7,1fr); text-align:center; }
    .calendar-dates div { padding:10px; cursor:pointer; }
    .calendar-dates .selected-date { background:#007bff; color:#fff; border-radius:50%; }
    
    /* Ïù∏Ï¶ù ÏÉÅÌÉú ÌëúÏãú */
    .auth-status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
    .auth-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .auth-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .auth-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    
    .btn { padding: 8px 16px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
  </style>
</head>

<body>
    <nav class="nav">
        <a class="logo" href="index.html">Zen Lab</a>
        <input id="menu-toggle" type="checkbox">
        <label class="menu-button-container" for="menu-toggle">
            <span class="menu-button"></span>
        </label>
        <ul class="menu">
            <li><a href="news.html">üéâNews</a></li>
            <li><a href="research.html">Research</a></li>
            <li><a href="members.html">Members</a></li>
            <li><a href="publications.html">Publications</a></li>
            <li><a href="teaching.html">Teaching</a></li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
    </nav>

    <main class="private-wrap">
    <section id="app">
        
        <!-- Ïù∏Ï¶ù ÏÉÅÌÉú ÌëúÏãú -->
        <div id="auth-status" class="auth-status auth-pending">
            Dropbox Ïó∞Í≤∞ ÌôïÏù∏ Ï§ë...
        </div>
        
        <div id="auth-actions" style="margin-bottom: 20px;">
            <button id="connect-btn" class="btn btn-primary" style="display:none;">Dropbox Ïó∞Í≤∞</button>
            <button id="disconnect-btn" class="btn btn-secondary" style="display:none;">Ïó∞Í≤∞ Ìï¥Ï†ú</button>
        </div>

        <!-- Todo -->
        <div class ="Todo">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
               <h3 id="todo-list">Todo List - YYYY.MM.DD</h3> 
               <div>
                   <button class="btn btn-secondary" id="loadBtntd" style="display:none;">Î∂àÎü¨Ïò§Í∏∞</button>
                   <button class="btn btn-success" id="saveBtntd" style="display:none;">Ï†ÄÏû•</button>
               </div>
            </div>
            <form class="js-toDoForm">
                <input type="text" placeholder="Write a to do" />
                <button type="button" class="js-addBtn">Add</button>
            </form>
            <ul class="js-toDoList">
            </ul>
        </div>

        <!-- Report -->
        <div class="report-editor">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 id="report-title">Daily Report - YYYY.MM.DD</h3>
                <div>
                    <button class="btn btn-secondary" id="loadBtn" style="display:none;">Î∂àÎü¨Ïò§Í∏∞</button>
                    <button class="btn btn-success" id="saveBtn" style="display:none;">Ï†ÄÏû•</button>
                </div>
            </div>
            <div class="rich-text-editor" id="report-content" contenteditable="true">
              <p>Write your daily report here...</p>
            </div>
        </div>
        
        <!-- Calendar -->
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prev-month">‚Äπ</button>
                <h3 id="month-year"></h3>
                <button id="next-month">‚Ä∫</button>
                <button id="today-btn">Today</button>
            </div>
            <div class="calendar-days">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div class="calendar-dates" id="calendar-dates"></div>
        </div>
    </section>
    </main>
    
    <footer class="footer">
        <div>&copy; <span id="year"></span> Zen Lab. All rights reserved.</div>
    </footer>

    <script>
      // ======= PKCE Ìó¨Ìçº Ìï®ÏàòÎì§ =======
      function base64URLEncode(str) {
          return btoa(String.fromCharCode.apply(null, str))
              .replace(/\+/g, '-')
              .replace(/\//g, '_')
              .replace(/=/g, '');
      }

      function generateRandomString(length) {
          const array = new Uint8Array(length);
          crypto.getRandomValues(array);
          return base64URLEncode(array);
      }

      async function sha256(plain) {
          const encoder = new TextEncoder();
          const data = encoder.encode(plain);
          return window.crypto.subtle.digest('SHA-256', data);
      }

      async function generatePKCEPair() {
          const codeVerifier = generateRandomString(32);
          const hashed = await sha256(codeVerifier);
          const codeChallenge = base64URLEncode(new Uint8Array(hashed));
          return { codeVerifier, codeChallenge };
      }
      
      // DOM ÏöîÏÜåÎì§
      const calendarDatesEl = document.getElementById('calendar-dates');
      const monthYearEl = document.getElementById('month-year');
      const prevBtn = document.getElementById('prev-month');
      const nextBtn = document.getElementById('next-month');
      const todayBtn = document.getElementById('today-btn');
      
      const todolistEl = document.getElementById('todo-list');
      const reportTitleEl = document.getElementById('report-title');
      const reportContentEl = document.getElementById('report-content');

      const saveBtntdEl = document.getElementById('saveBtntd');
      const saveBtnEl = document.getElementById('saveBtn');
      const loadBtntdEl = document.getElementById('loadBtntd');
      const loadBtnEl = document.getElementById('loadBtn');
      
      const authStatusEl = document.getElementById('auth-status');
      const connectBtnEl = document.getElementById('connect-btn');
      const disconnectBtnEl = document.getElementById('disconnect-btn');

      const APP_KEY = 'nubtwdkq9uvn2ka';
      const REDIRECT_URI = window.location.origin + '/private.html'; // auth.html ÎåÄÏã† ÏßÅÏ†ë Ï≤òÎ¶¨

      // ÎÇ†Ïßú Í¥ÄÎ†®
      const today = new Date();
      let currentDate = new Date();
      let selectedDate = new Date();
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      
      // Dropbox Ïù∏Ïä§ÌÑ¥Ïä§
      let dbx = null;
      
      // ======= Ïù∏Ï¶ù Í¥ÄÎ¶¨ =======
      function updateAuthStatus(status, message) {
          authStatusEl.className = `auth-status auth-${status}`;
          authStatusEl.textContent = message;
          
          const isConnected = status === 'success';
          connectBtnEl.style.display = isConnected ? 'none' : 'inline-block';
          disconnectBtnEl.style.display = isConnected ? 'inline-block' : 'none';
          
          // Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ Î≤ÑÌäº ÌëúÏãú
          const buttonsToToggle = [saveBtnEl, saveBtntdEl, loadBtnEl, loadBtntdEl];
          buttonsToToggle.forEach(btn => {
              if (btn) btn.style.display = isConnected ? 'inline-block' : 'none';
          });
      }
      
      function saveTokens(accessToken, refreshToken = null, codeVerifier = null) {
          const tokenData = {
              accessToken,
              refreshToken,
              codeVerifier,
              timestamp: Date.now()
          };
          localStorage.setItem('dropbox_tokens', JSON.stringify(tokenData));
      }
      
      function loadTokens() {
          try {
              const saved = localStorage.getItem('dropbox_tokens');
              if (!saved) return null;
              
              const tokenData = JSON.parse(saved);
              // ÌÜ†ÌÅ∞Ïù¥ 24ÏãúÍ∞Ñ Ïù¥ÏÉÅ Ïò§ÎûòÎêòÏóàÏúºÎ©¥ Î¨¥Ìö®Ìôî
              if (Date.now() - tokenData.timestamp > 24 * 60 * 60 * 1000) {
                  localStorage.removeItem('dropbox_tokens');
                  return null;
              }
              return tokenData;
          } catch (e) {
              console.error('ÌÜ†ÌÅ∞ Î°úÎìú Ïã§Ìå®:', e);
              return null;
          }
      }
      
      function clearTokens() {
          localStorage.removeItem('dropbox_tokens');
      }
      
      async function initializeDropbox() {
          try {
              // URLÏóêÏÑú Ïù∏Ï¶ù ÏΩîÎìú ÌôïÏù∏ (Ïù¥Ï†ú ÏßÅÏ†ë Ï≤òÎ¶¨)
              const urlParams = new URLSearchParams(window.location.search);
              const code = urlParams.get('code');
              
              if (code) {
                  // Ïù∏Ï¶ù ÏΩîÎìúÍ∞Ä ÏûàÏúºÎ©¥ ÌÜ†ÌÅ∞ ÍµêÌôò ÏãúÎèÑ
                  await handleAuthCode(code);
                  // URLÏóêÏÑú ÏΩîÎìú Ï†úÍ±∞
                  window.history.replaceState({}, document.title, window.location.pathname);
                  return;
              }
              
              // Ï†ÄÏû•Îêú ÌÜ†ÌÅ∞ ÌôïÏù∏
              const tokens = loadTokens();
              if (tokens && tokens.accessToken) {
                  dbx = new Dropbox.Dropbox({ accessToken: tokens.accessToken });
                  
                  // ÌÜ†ÌÅ∞ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                  try {
                      await dbx.usersGetCurrentAccount();
                      updateAuthStatus('success', 'Dropbox Ïó∞Í≤∞Îê®');
                      return;
                  } catch (e) {
                      console.log('Ï†ÄÏû•Îêú ÌÜ†ÌÅ∞Ïù¥ Ïú†Ìö®ÌïòÏßÄ ÏïäÏùå:', e);
                      clearTokens();
                  }
              }
              
              // Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùÄ ÏÉÅÌÉú
              updateAuthStatus('error', 'Dropbox Ïó∞Í≤∞ ÌïÑÏöî');
              
          } catch (e) {
              console.error('Dropbox Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', e);
              updateAuthStatus('error', 'Dropbox Ïó∞Í≤∞ Ïã§Ìå®: ' + e.message);
          }
      }
      
      async function handleAuthCode(code) {
          try {
              updateAuthStatus('pending', 'Ïù∏Ï¶ù Ï≤òÎ¶¨ Ï§ë...');
              
              // Ï†ÄÏû•Îêú code_verifier Í∞ÄÏ†∏Ïò§Í∏∞
              const tokens = loadTokens();
              const codeVerifier = tokens?.codeVerifier;
              
              if (!codeVerifier) {
                  throw new Error('PKCE code_verifierÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Ïãú Ïù∏Ï¶ùÌï¥Ï£ºÏÑ∏Ïöî.');
              }
              
              // PKCEÎ•º ÏÇ¨Ïö©Ìïú ÌÜ†ÌÅ∞ ÍµêÌôò
              const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: new URLSearchParams({
                      grant_type: 'authorization_code',
                      code: code,
                      client_id: APP_KEY,
                      redirect_uri: REDIRECT_URI,
                      code_verifier: codeVerifier // PKCE ÌïÑÏàò
                  })
              });
              
              if (!response.ok) {
                  const errorText = await response.text();
                  throw new Error(`HTTP ${response.status}: ${errorText}`);
              }
              
              const tokenData = await response.json();
              
              if (tokenData.access_token) {
                  saveTokens(tokenData.access_token, tokenData.refresh_token);
                  dbx = new Dropbox.Dropbox({ accessToken: tokenData.access_token });
                  
                  // Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
                  await dbx.usersGetCurrentAccount();
                  updateAuthStatus('success', 'Dropbox Ïó∞Í≤∞ ÏÑ±Í≥µ!');
              } else {
                  throw new Error('Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ÏùÑ Î∞õÏßÄ Î™ªÌñàÏäµÎãàÎã§');
              }
              
          } catch (e) {
              console.error('Ïù∏Ï¶ù Ï≤òÎ¶¨ Ïã§Ìå®:', e);
              updateAuthStatus('error', 'Ïù∏Ï¶ù Ïã§Ìå®: ' + e.message);
              clearTokens();
          }
      }
      
      async function connectToDropbox() {
          try {
              // PKCE ÏΩîÎìú ÏÉùÏÑ±
              const { codeVerifier, codeChallenge } = await generatePKCEPair();
              
              // code_verifierÎ•º ÏûÑÏãú Ï†ÄÏû• (Ïù∏Ï¶ù ÏôÑÎ£å ÌõÑ ÏÇ¨Ïö©)
              saveTokens(null, null, codeVerifier);
              
              // Ïù∏Ï¶ù URL ÏÉùÏÑ± (PKCE ÏÇ¨Ïö©)
              const authUrl = `https://www.dropbox.com/oauth2/authorize?` + new URLSearchParams({
                  client_id: APP_KEY,
                  response_type: 'code',
                  redirect_uri: REDIRECT_URI,
                  code_challenge: codeChallenge,
                  code_challenge_method: 'S256',
                  token_access_type: 'offline' // refresh tokenÏùÑ ÏúÑÌï¥
              });
              
              window.location.href = authUrl;
          } catch (e) {
              console.error('Ïù∏Ï¶ù URL ÏÉùÏÑ± Ïã§Ìå®:', e);
              updateAuthStatus('error', 'Ïù∏Ï¶ù ÏãúÏûë Ïã§Ìå®: ' + e.message);
          }
      }
      
      function disconnectFromDropbox() {
          clearTokens();
          dbx = null;
          updateAuthStatus('error', 'Dropbox Ïó∞Í≤∞ Ìï¥Ï†úÎê®');
      }

      async function getDropboxText(response) {
        // DropboxResponse.resultÏóê BlobÏù¥ Îã¥Í∏∞Îäî Î∏åÎùºÏö∞Ï†Ä ÏºÄÏù¥Ïä§
        if (response?.result?.fileBlob instanceof Blob) {
            return await response.result.fileBlob.text();
        }
        // ÌòπÏãú SDK/Îü∞ÌÉÄÏûÑÏóê Îî∞Îùº ArrayBufferÎ°ú Ïò§Îäî ÏºÄÏù¥Ïä§
        if (response?.result?.fileBinary) {
            // BufferSource ÎòêÎäî ArrayBuffer Í∞ÄÏ†ï
            if (typeof response.result.fileBinary.text === 'function') {
                return await response.result.fileBinary.text();
            }
            if (response.result.fileBinary instanceof ArrayBuffer) {
                return new TextDecoder('utf-8').decode(response.result.fileBinary);
            }
            // Uint8Array Îì±
            if (ArrayBuffer.isView(response.result.fileBinary)) {
                return new TextDecoder('utf-8').decode(response.result.fileBinary);
            }
        }
        throw new Error('ÌååÏùº Î≥∏Î¨∏ÏùÑ Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§ (fileBlob/fileBinary ÎØ∏Ï°¥Ïû¨).');
      }

      
      // ======= ÌååÏùº ÏóÖÎ°úÎìú/Îã§Ïö¥Î°úÎìú =======
      function formatDate(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
      }
      
      async function uploadReport() {
          if (!dbx) {
              alert('Î®ºÏ†Ä DropboxÏóê Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî');
              return;
          }
          
          try {
              const dateKey = formatDate(selectedDate);
              const fileName = `report-${dateKey}.html`;
              const html = `<!doctype html><html><head><meta charset="utf-8"><title>Report ${dateKey}</title></head><body>${reportContentEl.innerHTML}</body></html>`;
              
              await dbx.filesUpload({
                  path: `/${fileName}`,
                  contents: html,
                  mode: { '.tag': 'overwrite' }
              });
              
              alert('Report Ï†ÄÏû• ÏôÑÎ£å!');
          } catch (e) {
              console.error('Report ÏóÖÎ°úÎìú Ïã§Ìå®:', e);
              alert('Report Ï†ÄÏû• Ïã§Ìå®: ' + e.message);
          }
      }
      
      async function loadReport() {
          if (!dbx) {
              alert('Î®ºÏ†Ä DropboxÏóê Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî');
              return;
          }
          
          try {
              const dateKey = formatDate(selectedDate);
              const fileName = `report-${dateKey}.html`;
              
              const response = await dbx.filesDownload({ path: `/${fileName}` });
              const text = await getDropboxText(response);
              
              // HTMLÏóêÏÑú body ÎÇ¥Ïö©Îßå Ï∂îÏ∂ú
              const bodyMatch = text.match(/<body>(.*?)<\/body>/s);

              if (bodyMatch) {
                  reportContentEl.innerHTML = bodyMatch[1];
                  alert('Report Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å!');
              } else {
                  reportContentEl.innerHTML = text;
                  alert('Report Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å!');
              }
          } catch (e) {
              if (e.status === 409) {
                  alert('Ìï¥Îãπ ÎÇ†ÏßúÏùò ReportÍ∞Ä ÏóÜÏäµÎãàÎã§.');
              } else {
                  console.error('Report Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', e);
                  alert('Report Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ' + e.message);
              }
          }
      }
      
      function collectTodos() {
          const items = Array.from(document.querySelectorAll('.js-toDoList li'));
          return items.map(li => {
              const text = li.querySelector('span').innerText;
              const isChecked = li.querySelector('input[type="checkbox"]').checked;
              return { text: text, isChecked: isChecked };
          }).filter(item => item.text.trim());
      }
      
      // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÌòÑÏû¨ Todo Î™©Î°ù Ï†ÄÏû•
      function saveTodoToLocal() {
          const dateKey = formatDate(selectedDate);
          const todoItems = collectTodos();
          localStorage.setItem(`todo_${dateKey}`, JSON.stringify(todoItems));
      }
      
      // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Todo Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
      function loadTodoFromLocal() {
          const dateKey = formatDate(selectedDate);
          const saved = localStorage.getItem(`todo_${dateKey}`);
          
          const todoList = document.querySelector('.js-toDoList');
          todoList.innerHTML = ''; // Í∏∞Ï°¥ Î™©Î°ù ÌÅ¥Î¶¨Ïñ¥
          
          if (saved) {
              try {
                  const todoItems = JSON.parse(saved);
                  todoItems.forEach(item => {
                      if (item.text && item.text.trim()) {
                          addTodoItem(item.text, item.isChecked || false);
                      }
                  });
              } catch (e) {
                  console.error('Î°úÏª¨ Todo Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', e);
              }
          }
      }
      
      async function uploadTodo() {
          if (!dbx) {
              alert('Î®ºÏ†Ä DropboxÏóê Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî');
              return;
          }
          
          try {
              const dateKey = formatDate(selectedDate);
              const fileName = `todo-${dateKey}.json`;
              const payload = {
                  date: dateKey,
                  items: collectTodos(),
                  savedAt: new Date().toISOString()
              };
              
              await dbx.filesUpload({
                  path: `/${fileName}`,
                  contents: JSON.stringify(payload, null, 2),
                  mode: { '.tag': 'overwrite' }
              });
              
              alert('Todo List Ï†ÄÏû• ÏôÑÎ£å!');
          } catch (e) {
              console.error('Todo ÏóÖÎ°úÎìú Ïã§Ìå®:', e);
              alert('Todo List Ï†ÄÏû• Ïã§Ìå®: ' + e.message);
          }
      }
      
      async function loadTodo() {
          if (!dbx) {
              alert('Î®ºÏ†Ä DropboxÏóê Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî');
              return;
          }
          
          try {
              const dateKey = formatDate(selectedDate);
              const fileName = `todo-${dateKey}.json`;
              
              const response = await dbx.filesDownload({ path: `/${fileName}` });

              // ÏùëÎãµ Í∞ùÏ≤¥ Ï†ÑÏ≤¥Î•º ÏΩòÏÜîÏóê Ï∂úÎ†•ÌïòÏó¨ Ïñ¥Îñ§ Îç∞Ïù¥ÌÑ∞Í∞Ä Ïò§ÎäîÏßÄ ÌôïÏù∏
              console.log("Dropbox API ÏùëÎãµ:", response); 
              const text = await getDropboxText(response);
              const data = JSON.parse(text);
              
              // Í∏∞Ï°¥ todo Î¶¨Ïä§Ìä∏ ÌÅ¥Î¶¨Ïñ¥
              const todoList = document.querySelector('.js-toDoList');
              todoList.innerHTML = '';
              
              // Ï†ÄÏû•Îêú todo ÏïÑÏù¥ÌÖúÎì§ Ï∂îÍ∞Ä
              if (data.items && Array.isArray(data.items)) {
                  data.items.forEach(item => {
                      // ÏÉà ÌòïÏãù (Í∞ùÏ≤¥): { text, isChecked }
                      if (typeof item === 'object' && item.text) {
                          addTodoItem(item.text.trim(), item.isChecked || false);
                      }
                      // Íµ¨ ÌòïÏãù (Î¨∏ÏûêÏó¥): "text"
                      else if (typeof item === 'string' && item.trim()) {
                          addTodoItem(item.trim(), false);
                      }
                  });
              }
              
              alert('Todo List Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å!');
          } catch (e) {
              if (e.status === 409) {
                  alert('Ìï¥Îãπ ÎÇ†ÏßúÏùò Todo ListÍ∞Ä ÏóÜÏäµÎãàÎã§.');
              } else {
                  console.error('Todo Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', e);
                  alert('Todo List Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ' + e.message);
              }
          }
      }
      
      // Todo ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä Ìï®Ïàò (toDo.js Í∏∞Îä• ÌÜµÌï©)
      function addTodoItem(text, isChecked = false) {
          const todoList = document.querySelector('.js-toDoList');
          const li = document.createElement('li');
          
          // Ï≤¥ÌÅ¨Î∞ïÏä§ Ï∂îÍ∞Ä
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = isChecked;

          const delBtn = document.createElement('button');
          delBtn.innerText = 'X';
          
          const span = document.createElement('span');
          span.innerText = text;

          // Ï≤¥ÌÅ¨ÎêòÏñ¥ ÏûàÏúºÎ©¥ Ï∑®ÏÜåÏÑ† Ï†ÅÏö©
          if (isChecked) {
              span.style.textDecoration = 'line-through';
          }

          li.appendChild(checkbox);
          li.appendChild(span);
          li.appendChild(delBtn);
          todoList.appendChild(li);

          // Ï≤¥ÌÅ¨Î∞ïÏä§Î•º ÌÅ¥Î¶≠ÌñàÏùÑ Îïå, Ìï¥Îãπ Ìï≠Î™©Ïóê ÏôÑÎ£å Ïä§ÌÉÄÏùºÏùÑ Ï∂îÍ∞Ä/Ï†úÍ±∞
          checkbox.addEventListener('click', () => {
              span.style.textDecoration = checkbox.checked ? 'line-through' : 'none';
              saveTodoToLocal(); // Î°úÏª¨ Ï†ÄÏû•
          });

          // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ìï≠Î™© ÏÇ≠Ï†ú
          delBtn.addEventListener('click', (event) => {
              const li = event.target.parentElement;
              todoList.removeChild(li);
              saveTodoToLocal(); // ÏÇ≠Ï†ú ÌõÑ Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Í∞±Ïã†
          });

          saveTodoToLocal(); // Ï∂îÍ∞Ä ÌõÑ Î°úÏª¨ Ï†ÄÏû•
      }
      
      // ======= Îã¨Î†• Í¥ÄÎ†® =======
      function renderCalendar() {
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();

          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
          
          monthYearEl.textContent = `${monthNames[month]} ${year}`;
          calendarDatesEl.innerHTML = '';
          
          for (let i = 0; i < firstDayOfMonth; i++) {
              calendarDatesEl.innerHTML += '<div></div>';
          }
          
          for (let i = 1; i <= lastDateOfMonth; i++) {
              const dayEl = document.createElement('div');
              dayEl.textContent = i;
              dayEl.dataset.date = formatDate(new Date(year, month, i));
              
              if (dayEl.dataset.date === formatDate(selectedDate)) {
                  dayEl.classList.add('selected-date');
              }

              dayEl.addEventListener('click', () => {
                  selectedDate = new Date(year, month, i);
                  updateReportDisplay();
                  renderCalendar();
              });
              
              calendarDatesEl.appendChild(dayEl);
          }
      }

      function updateReportDisplay() {
          const dateKey = formatDate(selectedDate);
          reportTitleEl.textContent = `Daily Report - ${dateKey}`;
          todolistEl.textContent = `Todo List - ${dateKey}`;
          
          const isToday = formatDate(selectedDate) === formatDate(today);

          if (isToday) {
              reportContentEl.contentEditable = "true";
          } else {
              reportContentEl.contentEditable = "false";
          }

          // Î°úÏª¨ Ï†ÄÏû•ÏÜåÏóêÏÑú Report Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
          const savedContent = localStorage.getItem(`report_${dateKey}`);
          if (savedContent) {
              reportContentEl.innerHTML = savedContent;
          } else {
              reportContentEl.innerHTML = '<p>No report for this date.</p>';
          }
          
          // Todo Î™©Î°ùÎèÑ ÎÇ†ÏßúÎ≥ÑÎ°ú Î∂àÎü¨Ïò§Í∏∞
          loadTodoFromLocal();
      }
      
      function handleTodayClick() {
          currentDate = new Date();
          selectedDate = new Date();
          updateReportDisplay();
          renderCalendar();
      }
      
      // ======= ÏûêÏ†ï Î¶¨ÏÖã Í∏∞Îä• (toDo.jsÏóêÏÑú Í∞ÄÏ†∏Ïò¥) =======
      function checkAndResetIfNewDay() {
          const today = new Date().toDateString();
          const lastVisit = localStorage.getItem('lastVisitDate');
          
          if (lastVisit !== today) {
              // ÏÉàÎ°úÏö¥ ÎÇ†Ïù¥Î©¥ Ïò§Îäò ÎÇ†ÏßúÎ°ú Ïù¥ÎèôÌïòÍ≥† Ïò§Îäò Îç∞Ïù¥ÌÑ∞ Î°úÎìú
              localStorage.setItem('lastVisitDate', today);
              const todayDate = new Date();
              
              if (formatDate(selectedDate) !== formatDate(todayDate)) {
                  selectedDate = todayDate;
                  currentDate = todayDate;
                  updateReportDisplay();
                  renderCalendar();
              }
          }
      }
      
      // ÏûêÏ†ïÎßàÎã§ Ï≤¥ÌÅ¨ÌïòÎèÑÎ°ù ÏÑ§Ï†ï
      function setupMidnightReset() {
          const now = new Date();
          const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
          const msUntilMidnight = tomorrow - now;

          setTimeout(() => {
              checkAndResetIfNewDay();
              setupMidnightReset(); // Îã§Ïãú ÏÑ§Ï†ï
          }, msUntilMidnight);
      }
      connectBtnEl.addEventListener('click', connectToDropbox);
      disconnectBtnEl.addEventListener('click', disconnectFromDropbox);
      
      saveBtnEl.addEventListener('click', uploadReport);
      saveBtntdEl.addEventListener('click', uploadTodo);
      loadBtnEl.addEventListener('click', loadReport);
      loadBtntdEl.addEventListener('click', loadTodo);
      
      prevBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); });
      nextBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); });
      todayBtn.addEventListener('click', handleTodayClick);
      
      // ======= Ï¥àÍ∏∞Ìôî =======
      document.addEventListener('DOMContentLoaded', async () => {
          await initializeDropbox();
          checkAndResetIfNewDay(); // ÎÇ†Ïßú Ï≤¥ÌÅ¨
          setupMidnightReset(); // ÏûêÏ†ï Î¶¨ÏÖã ÏÑ§Ï†ï
          handleTodayClick();
          document.getElementById('year').textContent = new Date().getFullYear();
      });
      
      // Todo Ìèº Ïù¥Î≤§Ìä∏ (Í∏∞Ï°¥ Í∏∞Îä• Ïú†ÏßÄ)
      const todoForm = document.querySelector('.js-toDoForm');
      if (todoForm) {
          const todoInput = todoForm.querySelector('input');
          const addBtnElement = todoForm.querySelector('.js-addBtn');
          
          if (addBtnElement && todoInput) {
              addBtnElement.addEventListener('click', () => {
                  const text = todoInput.value.trim();
                  if (text) {
                      addTodoItem(text);
                      todoInput.value = '';
                  }
              });
              
              todoInput.addEventListener('keypress', (e) => {
                  if (e.key === 'Enter') {
                      e.preventDefault();
                      addBtnElement.click();
                  }
              });
          }
      }
    </script>
</body>
</html>